<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程 -</title><meta name=Description content="什么是 MetalLB，MetalLB 部署与测试，工作流程，Layer2 模式和 BGP 模式各种工作原理及使用建议"><meta property="og:title" content="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><meta property="og:description" content="什么是 MetalLB，MetalLB 部署与测试，工作流程，Layer2 模式和 BGP 模式各种工作原理及使用建议"><meta property="og:type" content="article"><meta property="og:url" content="https://tornado404.github.io/posts/cloudnative/01-metallb/"><meta property="og:image" content="https://tornado404.github.io/img/jinx.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-11T00:00:00+00:00"><meta property="og:site_name" content="钟子期的个人博客"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tornado404.github.io/img/jinx.png"><meta name=twitter:title content="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><meta name=twitter:description content="什么是 MetalLB，MetalLB 部署与测试，工作流程，Layer2 模式和 BGP 模式各种工作原理及使用建议"><meta name=application-name content="观海听涛"><meta name=apple-mobile-web-app-title content="观海听涛"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://tornado404.github.io/posts/cloudnative/01-metallb/><link rel=prev href=https://tornado404.github.io/posts/tekton/03-tekton-trigger/><link rel=stylesheet href=/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tornado404.github.io\/posts\/cloudnative\/01-metallb\/"},"image":["https:\/\/tornado404.github.io\/img\/jinx.png"],"genre":"posts","keywords":"CloudNative, MetalLB","wordcount":4418,"url":"https:\/\/tornado404.github.io\/posts\/cloudnative\/01-metallb\/","datePublished":"2023-02-11T00:00:00+00:00","dateModified":"2023-02-11T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"钟子期"},"description":"什么是 MetalLB，MetalLB 部署与测试，工作流程，Layer2 模式和 BGP 模式各种工作原理及使用建议"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title>观海听涛</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title=观海听涛>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/ title=关于>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title>观海听涛</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title=观海听涛>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://tornado404.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>钟子期</a></span>&nbsp;<span class=post-category>included in <a href=/categories/cloudnative/><i class="far fa-folder fa-fw" aria-hidden=true></i>CloudNative</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-11>2023-02-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;4418 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#0-什么是-metallb>0. 什么是 MetalLB</a></li><li><a href=#1-quickstart>1. QuickStart</a><ul><li><a href=#限制条件>限制条件</a></li><li><a href=#安装-metallb>安装 MetalLB</a></li><li><a href=#配置>配置</a></li><li><a href=#测试>测试</a></li></ul></li><li><a href=#2-工作流程>2. 工作流程</a></li><li><a href=#3-layer2-模式工作原理>3. Layer2 模式工作原理</a><ul><li><a href=#大致原理>大致原理</a></li><li><a href=#局限性>局限性</a></li></ul></li><li><a href=#4-bgp-模式工作原理>4. BGP 模式工作原理</a><ul><li><a href=#大致原理-1>大致原理</a></li><li><a href=#局限性-1>局限性</a></li><li><a href=#兼容性>兼容性</a></li></ul></li><li><a href=#5-小结>5. 小结</a></li></ul></nav></div></div><div class=content id=content><p>本文包括以下内容：什么是 MetalLB，MetalLB 部署及测试，MetalLB 工作流程，Layer2 模式和 BGP 模式各种工作原理及使用建议。</p><h2 id=0-什么是-metallb>0. 什么是 MetalLB</h2><blockquote><p>Repo: <a href=https://github.com/metallb/metallb target=_blank rel="noopener noreffer">https://github.com/metallb/metallb</a></p><p>官网: <a href=https://metallb.universe.tf/installation target=_blank rel="noopener noreffer">https://metallb.universe.tf/installation</a></p></blockquote><p><strong>一句话描述，什么是 MetalLB</strong>：</p><p><strong>MetalLB is a load-balancer implementation for bare metal <a href=https://kubernetes.io/ target=_blank rel="noopener noreffer">Kubernetes</a> clusters, using standard routing protocols.</strong></p><p>MetalLB 是一个用于裸机 Kubernetes 集群的负载均衡器实现，使用标准路由协议。</p><p>k8s 并没有为裸机集群实现负载均衡器，因此我们只有在以下 IaaS 平台（GCP, AWS, Azure）上才能使用 LoadBalancer 类型的 service。</p><p>因此裸机集群只能使用 NodePort 或者 externalIPs service 来对面暴露服务，然而这两种方式和 LoadBalancer service 相比都有很大的缺点。</p><p>而 MetalLB 的出现就是为了解决这个问题。</p><h2 id=1-quickstart>1. QuickStart</h2><h3 id=限制条件>限制条件</h3><p>安装 MetalLB 很简单，不过还是有一些限制：</p><ul><li>1）需要 Kubernetes v1.13.0 或者更新的版本</li><li>2）集群中的 CNI 要能兼容 MetalLB，具体兼容性参考这里 <a href=https://metallb.universe.tf/installation/network-addons/ target=_blank rel="noopener noreffer">network-addons</a><ul><li>像常见的 Flannel、Cilium 等都是兼容的，Calico 的话大部分情况都兼容，BGP 模式下需要额外处理</li></ul></li><li>3）提供一下 IPv4 地址给 MetalLB 用于分配<ul><li>一般在内网使用，提供同一网段的地址即可。</li></ul></li><li>4）BGP 模式下需要路由器支持 BGP</li><li>5）L2 模式下需要各个节点间 7946 端口联通</li></ul><p>看起来限制比较多，实际上这些都比较容器满足，除了第四条。</p><h3 id=安装-metallb>安装 MetalLB</h3><p>官方提供了好几种安装方式，yaml、helm、operator 等，这里使用 yaml 方式安装。</p><p>如果 kube-proxy 使用的是 ipvs 模式，需要修改 kube-proxy 配置文件，启用严格的 ARP</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>kubectl edit configmap -n kube-system kube-proxy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改点如下，黄色标记</span>
</span></span><span class=line><span class=cl>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span class=line><span class=cl>kind: KubeProxyConfiguration
</span></span><span class=line><span class=cl>mode: <span class=s2>&#34;ipvs&#34;</span>
</span></span><span class=line><span class=cl>ipvs:
</span></span><span class=line><span class=cl>  strictARP: <span class=nb>true</span>
</span></span></code></pre></div><p>使用 yaml 安装</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=c1># 原生</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-native.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用 FRR</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-frr.yaml
</span></span></code></pre></div><h3 id=配置>配置</h3><p>MetalLB 有 Layer2 模式和 BGP 模式，<strong>任选一种模式进行配置即可</strong>。</p><blockquote><p>因为 BGP 对路由器有要求，因此建议测试时使用 Layer2 模式。</p></blockquote><h4 id=layer-2-模式配置>Layer 2 模式配置</h4><p><strong>1）创建 IPAdressPool</strong></p><blockquote><p>多个实例<code>IP地址池</code>可以共存,并且地址可以由CIDR定义， 按范围分配，并且可以分配IPV4和IPV6地址。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; IPAddressPool.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: metallb.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: IPAddressPool
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: first-pool
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  addresses:
</span></span></span><span class=line><span class=cl><span class=s>  # 可分配的 IP 地址,可以指定多个，包括 ipv4、ipv6
</span></span></span><span class=line><span class=cl><span class=s>  - 172.20.175.140-172.20.175.150
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f IPAddressPool.yaml
</span></span></code></pre></div><p><strong>2）创建 L2Advertisement，并关联 IPAdressPool</strong></p><blockquote><p>L2 模式不要求将 IP 绑定到网络接口 工作节点。它的工作原理是响应本地网络 arp 请求，以将计算机的 MAC 地址提供给客户端。</p></blockquote><p>如果不设置关联到 IPAdressPool，那默认 L2Advertisement 会关联上所有可用的 IPAdressPool</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; L2Advertisement.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: metallb.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: L2Advertisement
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: example
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ipAddressPools:
</span></span></span><span class=line><span class=cl><span class=s>  - first-pool #上一步创建的 ip 地址池，通过名字进行关联
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f L2Advertisement.yaml
</span></span></code></pre></div><h4 id=bgp-模式配置>BGP 模式配置</h4><p><strong>1）配置 BGPPeer</strong></p><p>需要为每个需要连接的路由器都创建一个 BGPPeer 实例，这样 MetalLB 才能与 BGP 路由器建立会话。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; BGPPeer.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: metallb.io/v1beta2
</span></span></span><span class=line><span class=cl><span class=s>kind: BGPPeer
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: sample
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  myASN: 64500 # MetalLB 使用的 AS 号
</span></span></span><span class=line><span class=cl><span class=s>  peerASN: 64501 # 路由器的 AS 号
</span></span></span><span class=line><span class=cl><span class=s>  peerAddress: 10.0.0.1 # 路由器地址
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f BGPPeer.yaml
</span></span></code></pre></div><p><strong>2）创建 IPAdressPool</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; IPAddressPool.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: metallb.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: IPAddressPool
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: first-pool
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  addresses:
</span></span></span><span class=line><span class=cl><span class=s>  - 192.168.1.240-192.168.1.250 # 可分配的 IP 地址
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f IPAddressPool.yaml
</span></span></code></pre></div><p><strong>3）创建 L2Advertisement，并关联 IPAdressPool</strong></p><p>如果不设置关联到 IPAdressPool，那默认 L2Advertisement 会关联上所有可用的 IPAdressPool。</p><p>也可以使用标签选择器来筛选需要关联的 IPAdressPool 列表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; L2Advertisement.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: metallb.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: L2Advertisement
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: example
</span></span></span><span class=line><span class=cl><span class=s>  namespace: metallb-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ipAddressPools:
</span></span></span><span class=line><span class=cl><span class=s>  - first-pool
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f  L2Advertisement.yaml
</span></span></code></pre></div><p>启动 FRR 作为 BGP 的后端，不需要额外的配置，只是在安装的时候会创建不同的 CR。启动 FRR 模式后，需要用到某些特性要单独进行配置。</p><h3 id=测试>测试</h3><p>创建一个 nginx deploy 以及一个 loadbalance 类型的 svc 来测试。</p><p>使用以下命令创建 nginx deploy：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; nginx-dp.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx-deployment
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: nginx
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: nginx
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: nginx
</span></span></span><span class=line><span class=cl><span class=s>        image: docker.io/nginx:latest
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 80
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f nginx-dp.yaml
</span></span></code></pre></div><p>使用以下命令创建 nginx-svc：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; nginx-svc.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: nginx2
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: nginx
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - name: nginx-port
</span></span></span><span class=line><span class=cl><span class=s>    protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    port: 80
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 80
</span></span></span><span class=line><span class=cl><span class=s>  type: LoadBalancer
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f nginx-svc.yaml
</span></span></code></pre></div><p>然后查看 svc，看看是不是真的分配了 ExternalIP</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=o>[</span>root@iam2 ~<span class=o>]</span><span class=c1># kubectl get svc nginx</span>
</span></span><span class=line><span class=cl>NAME    TYPE           CLUSTER-IP       EXTERNAL-IP     PORT<span class=o>(</span>S<span class=o>)</span>        AGE
</span></span><span class=line><span class=cl>nginx   LoadBalancer   10.103.240.239   192.168.1.241   80:30164/TCP   5s
</span></span></code></pre></div><p>访问对应的 EXTERNAL-IP</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>curl http://192.168.1.241
</span></span></code></pre></div><p>能够访问，说明 LB 正常工作。</p><h2 id=2-工作流程>2. 工作流程</h2><p>MetalLB 做的工作可以分为两个部分：</p><ul><li>1）<strong>地址分配</strong>：当创建 <em>LoadBalancer</em> Service 时，MetalLB 会为其分配 IP 地址。这个 IP 地址是从<strong>预先配置的 IP 地址库</strong>获取的。同样，当 Service 删除后，已分配的 IP 地址会重新回到地址库。</li><li>2）<strong>对外广播</strong>：分配了 IP 地址之后，需要<strong>让集群外的网络知道这个地址的存在</strong>。MetalLB 使用了标准路由协议实现：ARP、NDP 或者 BGP。<ul><li>在 Layer 2 模式，使用 ARP（ipv4）/NDP（ipv6） 协议；</li><li>在 BPG 模式，自然是使用 BGP 协议。</li></ul></li></ul><blockquote><p><em><strong>ARP（Address Resolution Protocol）</strong></em>：是根据IP地址获取物理地址的一个TCP/IP协议。</p><p><em><strong>NDP（neighbor Discovery protocol）</strong></em>：是ICMPv6的子协议是IPV6协议体系中一个重要的基础协议，邻居发现协议替代了IPV4的ARP，ICMP路由器发现。它定义了使用ICMPv6报文实现地址解析，跟踪邻居状态，重复地址检测，路由器发现，以及重定向等功能。</p></blockquote><p>同时 MetalLB 分别使用两个组件来实现了上述两个功能：</p><ul><li><strong>Controller</strong>：实现地址分配，以 <em>Deployment</em> 方式运行，用于监听 Service 的变更，分配/回收 IP 地址。</li><li><strong>Speaker</strong>：实现地址对外广播，以 <em>DaemonSet</em> 方式运行，对外广播 Service 的 IP 地址。</li></ul><p>具体的工作流如下：</p><ul><li><strong>Controller 负责监听 Service 变化并分配或回收 IP</strong>，当 Service 配置为 LoadBalancer 模式时，从 IP 池分配给到相应的 IP 地址并对该 IP 的生命周期进行管理。<ul><li>创建 Service 时（或者从非 LoadBalancer 类型修改为 LoadBalancer 类型）时从 IP 池选择一个 IP 并分配，</li><li>删除 Service （或者从 LoadBalancer 类型修改为非 LoadBalancer 类型）时回收该 IP 到 IP 池</li></ul></li><li><strong>Speaker 则会依据选择的协议进行相应的广播或应答，实现 IP 地址的通信响应</strong>。当业务流量通过 TCP/UDP 协议到达指定的 Node 时，由 Node 上面运行的 Kube-Proxy 组件对流量进行处理，并分发到对应服务的 Pod 上面。<ul><li>如果是 Layer2 模式 Speaker 就会响应 ARP（ipv4）/NDP（ipv6）请求</li><li>如果是 BGP 模式 Speaker 则发送 BGP 广播，将路由规则同步给 peer。</li></ul></li></ul><h2 id=3-layer2-模式工作原理>3. Layer2 模式工作原理</h2><blockquote><p><a href=https://metallb.universe.tf/concepts/layer2/ target=_blank rel="noopener noreffer">METALLB IN LAYER 2 MODE</a></p></blockquote><h3 id=大致原理>大致原理</h3><p>Layer 2 中的 Speaker 工作负载是 DeamonSet 类型，在每个节点上都调度一个 Pod，首先，几个 Pod 会先进行选举，选举出 Leader。</p><p>由 Leader Pod 获取所有 LoadBalancer 类型的 Service，并将已分配的 IP 地址绑定到当前主机到网卡上。同时该 Leader 会响应对 ExternalIP 的 ARP（ipv4）/NDP（ipv6） 请求，因此从局域网层面来看，speaker 所在的机器是有多个 IP 地址的，当前其中也包含 ExternalIP。</p><blockquote><p>从网络的角度来看，计算机的网络接口分配了多个IP地址,因为对不同 ip 地址的 arp 请求返回的都是这个节点的 mac 地址。</p></blockquote><p>因此与 ExternalIP 相关的所有流量都会流向该节点。在该节点上， kube-proxy 将接收到的流量传播到对应 Service 的后端 Pod。</p><blockquote><p><strong>也就是说，所有 LoadBalancer 类型的 Service 的 IP 同一时间都是绑定在同一台节点的网卡上。</strong></p></blockquote><h3 id=局限性>局限性</h3><p>在 Layer2 模式中会存在以下两种局限性：<strong>单节点瓶颈</strong>和<strong>故障转移慢</strong>。</p><h4 id=单节点瓶颈>单节点瓶颈</h4><p>由于 Layer 2 模式会使用单个选举出来的 Leader 来接收 ExternalIP 的所有流量，这就意味着服务的入口带宽被限制为单个节点的带宽，单节点的流量处理能力将成为整个集群的接收外部流量的瓶颈。</p><blockquote><p>从这个角度来看，Layer2 模式更像是实现了<strong>故障转移</strong>，而不是负载均衡，因为同时只能在一个节点负责接收数据。</p></blockquote><h4 id=故障转移慢>故障转移慢</h4><p>在故障转移方面，MetalLB 也实现了<strong>自动故障转移</strong>。目前的机制是通过 <a href=https://github.com/hashicorp/memberlist target=_blank rel="noopener noreffer">memberlist</a> 这个基于 gossip 协议的成员和故障检测的库，其他节点检测到 Leader 故障后自动重新选举出新 Leader，新的 Leader 自动接管所有 ExternalIP 并发送大量 二层数据包来通知客户端(也就是区域网中的其他节点) ExternalIP 的 MAC 地址变化。</p><blockquote><p>大部分操作系统都能处理这部分 二层数据包并更新 <strong>neighbor caches</strong>，但是也有极少部分系统不能正确处理这个数据包，从而无法及时更新缓存，还会继续请求旧的 Leader 节点，这种情况下可以让旧 Leader 多存活几分钟，用于处理这部分客户端的请求。</p></blockquote><p>根据官网文档描述<strong>故障转移正常情况下会在几秒内完成</strong>，一般不会超过 10 秒。但是在更新完成前 ExternalIP 会无法访问。</p><blockquote><p>即：会出现几秒钟的服务中断</p><p>这个 10s 只是官方说的，可能经常测试或者是一个大概值，和这段 <a href=https://github.com/metallb/metallb/blob/main/internal/layer2/announcer.go#L51 target=_blank rel="noopener noreffer">代码#announcer.go#L51</a> 里的10s 的循环不是一回事</p></blockquote><h2 id=4-bgp-模式工作原理>4. BGP 模式工作原理</h2><blockquote><p><a href=https://metallb.universe.tf/concepts/bgp/ target=_blank rel="noopener noreffer">METALLB IN BGP MODE</a></p></blockquote><h3 id=大致原理-1>大致原理</h3><p>在 BGP 模式下每个节点（ 上的 Speaker Pod）都会和路由器建立一个 BGP peer session，并且通过这些 peer session 来告知外部网络 ExternalIPs 的存在。</p><p>BGP模式是以集群中的主机与对等体进行共享路由信息，从而实现集群外部的服务能够访问到集群内部的服务。</p><p>和 Layer2 模式不同，<strong>BGP模式真正的实现了负载均衡</strong>，不过具体的负载均衡行为和路由器以及配置有关系。一般默认的行为是根据数据包中的某些<strong>关键字段</strong>进行 hash，并更新 hash 值分配给其中某一个连接。</p><blockquote><p>原文：but the common behavior is to balance <em>per-connection</em>, based on a <em>packet hash</em>.</p></blockquote><p>关键字段常见选择为 <strong>三元组（协议、源IP、目的IP）</strong> 或者<strong>五元组（协议、源IP、目的IP、源端口、目的端口）</strong></p><p>也就是说默认情况下一个连接里的所有数据包都会发送到固定的节点，这样能拥有更好的性能。</p><h3 id=局限性-1>局限性</h3><p>BGP 模式最大的弊端就是<strong>不能优雅的处理节点下线</strong>。当集群中某个节点下线时，所有客户端对这个节点的连接都会被主动断开。</p><blockquote><p>客户端一般会出现一个 Connection reset by peer 错误</p></blockquote><p>同时由于是<strong>对每个数据包基于 hash 值进行负载均衡</strong>，因此<strong>对后端节点数是非常敏感</strong>的，这也是 BGP 的一个优点，<strong>故障转移非常快。</strong></p><p><strong>正因为</strong> <strong>BGP</strong> <strong>故障转移很快，反而引发了一个 BGP 模式的最大缺点</strong>：由于 BGP 会对每个数据包做负载均衡，在主机发生故障时会快速切换到新的主机上，从而引发节点变动时<strong>同一连接的不同数据包可能会发送到不同主机上导致网络导致的网络重排问题</strong>。</p><blockquote><p>比如第一个包转发到节点 A，然后处理第二个包时添加或故障了一个节点，按照新的节点数进行负载均衡计算，可能第二个数据包就被分到节点 B 了，节点 B 很明显是不能正确处理这个数据包的。</p><p>对客户端来说就是这次请求直接失败了。</p></blockquote><p>解决该弊端的方法没有太理想的解决办法，只能尽量采取一些优化手段：</p><ul><li>1）路由器配置更加稳定的 hash 算法，比如 &ldquo;resilient ECMP&rdquo; 或者 &ldquo;resilient LAG&rdquo;。使用这样的算法极大地减少了 后端节点更改时受影响的连接。</li><li>2）尽量少的增删节点</li><li>3）在流量少时变更节点，以降低影响</li><li>4）使用 ingress 来对外暴露服务等等</li><li>&mldr;.</li></ul><h3 id=兼容性>兼容性</h3><p>因为 BGP 单 session 的限制，如果 CNI 插件为 Calico ，同时 Calico 也是使用的 BGP 模式，就会有冲突从而导致 MetalLB 无法正常工作。</p><blockquote><p>Calico 和 MetalLB 都会尝试建立 session</p></blockquote><h2 id=5-小结>5. 小结</h2><p>MetalLB 是一个用于裸机 Kubernetes 集群的负载均衡器实现，使用标准路由协议。</p><p>MetalLB 主要分为 Controller 和 Speaker 两个部分，<strong>Controller 负责 IPAM，Speaker 则负责 IP 通告</strong>。这两个组件就是实现 MetalLB 所需要的全部功能了。</p><p><strong>二者实现原理</strong></p><p>MetalLB 包括 Layer2 模式和 BGP 模式，主要区别在于 IP 通告部分的实现不一样：</p><ul><li>Layer2 模式通过响应对 ExternalIP 的 ARP（ipv4）/NDP（ipv6） 请求来告知其他节点某个 IP 在这台机器上<ul><li>arp 请求是在 二层的，这可能就是该模式为什么叫做 Layer2</li></ul></li><li>BGP 模式则通过于路由器建立 BGP peer session，从而进行数据同步，让路由器知道某个 IP 在这台机器上</li></ul><p><strong>二者优缺点</strong></p><p>Layer2 模式</p><ul><li>优点：<strong>通用性好</strong>，适用于任何网络环境，不需要特殊的硬件，甚至不需要花哨的路由器。</li><li>缺点：单节点瓶颈和故障转移慢</li></ul><p><strong>Layer2 模式是一种基础、通用的实现</strong>，能用，而且易于使用，没有任何限制，但是局限性比较大。</p><p>BGP 模式：</p><ul><li>优点：使用 BGP 可以在多节点间负载均衡，没有单节点瓶颈，同时故障转移很快。</li><li>缺点： 需要支持 BGP 路由协议的软路由或者硬件路由器设备。<ul><li>其实不能算缺点了，想要功能总得付出代价。</li></ul></li></ul><p><strong>使用建议</strong></p><p><strong>BGP</strong> <strong>模式则是比较理想的实现</strong>，除了依赖支持 BGP 的路由之外，其他方面则没有任何限制，并且没有可用性的问题</p><p><strong>一句话总结</strong>：如果说 Layer2 模式为基础实现，那么 BGP 模式则是 LoadBalance 的终极实现，能用 BGP 模式就尽量用 BGP 模式，否则的话就只能用 Layer2 模式了，如果不知道用什么模式的话直接用 Layer2 模式即可。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-11</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://tornado404.github.io/posts/cloudnative/01-metallb/ data-title="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程" data-hashtags=CloudNative,MetalLB><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://tornado404.github.io/posts/cloudnative/01-metallb/ data-hashtag=CloudNative><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://tornado404.github.io/posts/cloudnative/01-metallb/ data-title="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://tornado404.github.io/posts/cloudnative/01-metallb/ data-title="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://tornado404.github.io/posts/cloudnative/01-metallb/ data-title="裸机 Kubernetes 集群负载均衡器: MetalLB 简明教程"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/cloudnative/>CloudNative</a>,&nbsp;<a href=/tags/metallb/>MetalLB</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/tekton/03-tekton-trigger/ class=prev rel=prev title="Tekton教程(三)---解放双手：使用 Trigger 自动触发流水线"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Tekton教程(三)---解放双手：使用 Trigger 自动触发流水线</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://tornado404.github.io target=_blank>钟子期</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a rel="license external nofollow noopener noreffer" href=https://beian.miit.gov.cn/ target=_blank>渝ICP备20005680号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.b0df51c2c57145081cc73960e9aa780e6f5f56d06cf4ef0f96da8ce1619d1e12.js integrity="sha256-sN9RwsVxRQgcxzlg6ap4Dm9fVtBs9O8PltqM4WGdHhI="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FL23FNP7CM",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-FL23FNP7CM" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4b7c98449a6edf8492a8f3404e6d06a0",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7693630257897132" crossorigin=anonymous></script></body></html>